# Databricks 利用料ダッシュボード 変更仕様書

**文書作成日**: 2026年1月28日  
**対象ダッシュボード**: 利用料ダッシュボード (`dash-hhhd-dbks-mng-usage_updated260115.lvdash.json`)

---

## 1. 変更方針

### 1.1 基本方針
利用料ログの予算・閾値定義テーブル（`account_budget_contracts`）は**アカウントレベルのレコードのみ**を管理する。

### 1.2 累積利用料の集計期間
ワークスペース単位の累積利用料の集計期間は、登録された**アカウントレコードの契約開始日・終了日**に従う。

---

## 2. 変更理由

現状の仕様では、ワークスペース単位で予算・閾値の設定が必要であり、レコードが登録されていないワークスペースについては累積利用料の可視化ができませんでした。

本変更により、以下のメリットが得られます：

1. **予算・閾値テーブルにレコードがないワークスペースも累積利用料の可視化が可能**
2. 予算管理をアカウント単位に一元化し、運用負荷を軽減
3. 新規ワークスペース追加時の予算設定が不要

---

## 3. スキーマ変更

### 3.1 変更対象テーブル
`audit_validation.budget_schema.account_budget_contracts`

### 3.2 変更前スキーマ

| カラム名 | 説明 | 備考 |
|---------|------|------|
| `contract_id` | 契約ID | |
| `workspace_id` | ワークスペースID | **削除対象** |
| `scope_type` | スコープタイプ（`ACCOUNT`/`WORKSPACE`） | **削除対象** |
| `budget_usd` | 予算金額（USD） | |
| `threshold_usd` | 閾値金額（USD） | **削除対象** |
| `contract_start_date` | 契約開始日 | |
| `contract_end_date` | 契約終了日 | |
| `active` | 有効フラグ | **削除対象** |
| `updated_at` | 更新日時 | |

### 3.3 変更後スキーマ

| カラム名 | 説明 |
|---------|------|
| `contract_id` | 契約ID |
| `budget_usd` | 予算金額（USD） |
| `threshold_usd` | 閾値金額（USD） |
| `contract_start_date` | 契約開始日 |
| `contract_end_date` | 契約終了日 |
| `updated_at` | 更新日時 |

### 3.4 削除カラム一覧

| カラム名 | 削除理由 |
|---------|---------|
| `workspace_id` | アカウント単位管理への変更により不要 |
| `scope_type` | アカウントレコードのみ管理するため不要 |
| `active` | シンプル化のため廃止 |

---

## 4. クエリ変更

### 4.1 影響を受けるデータセット

| データセット名 | 変更内容 |
|--------------|---------|
| `budget_vs_actual` | 予算取得ロジックの簡素化 |
| `budget_vs_actual_260115` | 予算取得ロジックの簡素化 |
| `cumulative_usage` | 契約期間取得ロジックの変更 |

### 4.2 変更前のロジック（概要）

```sql
-- 変更前：ワークスペース個別 or アカウント全体で分岐
target_budgets AS (
  SELECT
    CASE
      WHEN :param_workspace = '<ALL WORKSPACES>' THEN 'ALL'
      ELSE CAST(workspace_id AS STRING)
    END AS join_key,
    budget_usd,
    threshold_usd,
    ...
  FROM account_budget_contracts
  WHERE
    (
      :param_workspace = '<ALL WORKSPACES>'
      AND scope_type = 'ACCOUNT'
    )
    OR
    (
      :param_workspace <> '<ALL WORKSPACES>'
      AND workspace_id IN (SELECT workspace_id FROM target_workspace)
    )
)
```

### 4.3 変更後のロジック（概要）

```sql
-- 変更後：アカウントレコードのみ参照（シンプル化）
account_contract AS (
  SELECT
    contract_id,
    budget_usd,
    threshold_usd,
    contract_start_date,
    contract_end_date
  FROM account_budget_contracts
  WHERE updated_at = (
    SELECT MAX(updated_at) FROM account_budget_contracts
  )
)
```

### 4.4 累積利用料集計ロジックの変更

**変更前**:
- ワークスペース指定時: 該当ワークスペースの予算レコードの契約期間を使用
- 全ワークスペース指定時: アカウントレコードの契約期間を使用

**変更後**:
- **すべてのケースでアカウントレコードの契約期間を使用**
- ワークスペースごとの累積利用料は、アカウントの契約開始日から計算

---

## 5. ウィジェット変更

### 5.1 予実管理テーブル

**変更前カラム**:
1. 期間
2. 期間合計利用料
3. 期間累積利用料
4. 予算
5. 予算閾値
6. 予算超過フラグ
7. 閾値超過フラグ
8. 予算超過料
9. 閾値超過料

**変更後カラム**:
1. 期間
2. 期間合計利用料
3. 期間累積利用料
4. 予算
5. 予算閾値
6. 予算超過フラグ
7. 閾値超過フラグ
8. 予算超過料
9. 閾値超過料

> **注意**: カラム構成は変更なし。アカウントレベルの予算・閾値を使用するように変更。

### 5.2 累積利用料グラフ

**変更前**:
- 副Y軸に「予算」と「閾値」の2本のラインを表示

**変更後**:
- 副Y軸に「予算」と「閾値」の2本のラインを表示（変更なし）

---

## 6. パラメータ変更

### 6.1 削除対象パラメータ
なし（既存パラメータは維持）

### 6.2 動作変更

| パラメータ | 変更前の動作 | 変更後の動作 |
|-----------|-------------|-------------|
| `param_workspace` | ワークスペース個別の予算を参照 | アカウント予算の契約期間内で集計 |

---

## 7. 移行作業

### 7.1 データベース変更
1. `account_budget_contracts`テーブルから不要カラムを削除
2. 既存のワークスペース単位レコードを削除（アカウントレコードのみ残す）

### 7.2 ダッシュボード変更
1. データセットクエリの修正
2. ウィジェットのカラム設定変更
3. グラフの副Y軸設定変更

### 7.3 テストケース
1. 全ワークスペース選択時の累積利用料表示確認
2. 個別ワークスペース選択時の累積利用料表示確認
3. 予算超過フラグの正常動作確認
4. **予算レコードのないワークスペースでも累積利用料が表示されることの確認** ← 重要

---

## 8. 変更による影響

### 8.1 メリット
- ワークスペース単位の予算管理が不要になり運用負荷軽減
- 新規ワークスペース追加時の設定作業不要
- すべてのワークスペースで累積利用料の可視化が可能

### 8.2 注意点
- 既存のワークスペース個別予算は使用されなくなる
- アカウントレベルの予算・閾値がすべてのワークスペースに適用される

---

## 9. 変更履歴

| 日付 | バージョン | 変更内容 |
|-----|-----------|---------|
| 2026-01-28 | 1.0 | 初版作成 |
